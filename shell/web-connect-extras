#!/usr/bin/sh
# post web connection utilities

USER_HOME=/home/austin
RCLONE="rclone --config=$USER_HOME/.rclone.conf"

# testing connection
ping -c 3 www.google.com
echo "--------------------"

# firewall
echo "establishing firewall..."
$USER_HOME/documents/vault/iptables.rules
echo "--------------------"

# fetch for conky
echo "fetching things for conky..."
curl -o /tmp/ipinfo ipinfo.io                                                                   # ip info
curl http://www.ipinfodb.com/index.php | grep postal | tail -c 12 | head -c 5 > /tmp/zip        # zip code
curl -o /tmp/forecast wttr.in/$(cat /tmp/zip)                                                   # forecast / weather
checkupdates > /tmp/off.updates # official packages
echo "--------------------"

# create pc backup
echo "Creating PC Backup..."
echo "==> pruning pacman cache to 1 old version"
paccache -rk1 # clean /var/cache/pacman/pkg leaving one old version
rm /boot/{initramfs-linux.img,initramfs-linux-hardened-fallback.img # need to make space for upgrades on /boot
echo "==> getting list of packages"
pacman -Qqm > $USER_HOME/mega/pc_backup/system/aur.pkglist
pacman -Qe > $USER_HOME/mega/pc_backup/system/off.pkglist
echo "==> creating archives"
tar -czf $USER_HOME/mega/pc_backup/system/etc.tar.gz /etc
tar -czf $USER_HOME/mega/pc_backup/system/boot.tar.gz /boot
tar --exclude={keys,vault} -czf $USER_HOME/mega/pc_backup/$USER_HOME/documents.tar.gz $USER_HOME/documents
echo "--------------------"

# push to backups to Mega
echo "Pushing PC and Phone Backups to Mega..."
$RCLONE sync --ignore-times $USER_HOME/mega/pc_backup/ mega:/pc_backup/
$RCLONE sync --ignore-times $USER_HOME/mega/phone_backup/ mega:/phone_backup/
echo "--------------------"

# pulling from Google Drive
echo "Pulling  Google Drive ..."
$RCLONE sync gdrive_professional:/ $USER_HOME/gdrive_professional/
$RCLONE sync gdrive_personal:/ $USER_HOME/gdrive_personal/
echo "Pushing PC and Phone Backups to Google Drive..."
rsync -aAXv $USER_HOME/mega/pc_backup/ $USER_HOME/gdrive_personal/pc_backup/
rsync -aAXv --exclude=sdcard/{Music,TitaniumBackup} $USER_HOME/mega/phone_backup/ $USER_HOME/gdrive_personal/phone_backup/
$RCLONE sync $USER_HOME/gdrive_personal/ gdrive_personal:/

echo "--------------------"
# start local backup server
echo "Starting Syncthing Daemon..."
systemctl start syncthing@austin.service

# start mining crypto
#echo "Starting Minergate..."
#minergate-cli -u austin.haedicke@gmail.com --xmr 2
